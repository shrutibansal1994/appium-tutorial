'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumUiautomator = require('appium-uiautomator');

var _appiumUiautomator2 = _interopRequireDefault(_appiumUiautomator);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var log = _appiumSupport.logger.getLogger('AndroidBootstrap');
var COMMAND_TYPES = {
  ACTION: 'action',
  SHUTDOWN: 'shutdown'
};
var SEND_COMMAND_TIMEOUT = 1 * 60 * 1000;

var AndroidBootstrap = (function () {
  function AndroidBootstrap(adb) {
    var systemPort = arguments.length <= 1 || arguments[1] === undefined ? 4724 : arguments[1];
    var webSocket = arguments.length <= 2 || arguments[2] === undefined ? undefined : arguments[2];

    _classCallCheck(this, AndroidBootstrap);

    this.adb = adb;
    this.systemPort = systemPort;
    this.webSocket = webSocket;
    this.ignoreUnexpectedShutdown = false;
  }

  _createClass(AndroidBootstrap, [{
    key: 'start',
    value: function start(appPackage) {
      var disableAndroidWatchers = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];
      var acceptSslCerts = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
      var rootDir, startDetector, bootstrapJar;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            rootDir = _path2['default'].resolve(__dirname, '..', '..');

            startDetector = function startDetector(s) {
              return (/Appium Socket Server Ready/.test(s)
              );
            };

            bootstrapJar = _path2['default'].resolve(rootDir, 'bootstrap', 'bin', 'AppiumBootstrap.jar');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.init());

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.adb.forwardPort(this.systemPort, 4724));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.uiAutomator.start(bootstrapJar, 'io.appium.android.bootstrap.Bootstrap', startDetector, '-e', 'pkg', appPackage, '-e', 'disableAndroidWatchers', disableAndroidWatchers, '-e', 'acceptSslCerts', acceptSslCerts));

          case 10:
            this.process = context$2$0.sent;

            // process the output
            this.process.on('output', function (stdout, stderr) {
              var alertRe = /Emitting system alert message/;
              if (alertRe.test(stdout)) {
                log.debug("Emitting alert message...");
                if (_this.webSocket) {
                  _this.webSocket.sockets.emit('alert', { message: stdout });
                }
              }

              // the bootstrap logger wraps its own log lines with
              // [APPIUM-UIAUTO] ... [APPIUM-UIAUTO]
              // and leaves actual UiAutomator logs as they are
              var stdoutLines = (stdout || "").split("\n");
              var uiautoLog = /\[APPIUM-UIAUTO\](.+)\[\/APPIUM-UIAUTO\]/;
              var _iteratorNormalCompletion = true;
              var _didIteratorError = false;
              var _iteratorError = undefined;

              try {
                for (var _iterator = _getIterator(stdoutLines), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                  var line = _step.value;

                  if (line.trim()) {
                    if (uiautoLog.test(line)) {
                      var innerLine = uiautoLog.exec(line)[1].trim();
                      var logMethod = log.info.bind(log);
                      // if the bootstrap log considers something debug, log that as
                      // debug and not info
                      if (/\[debug\]/.test(innerLine)) {
                        logMethod = log.debug.bind(log);
                      }
                      logMethod('[BOOTSTRAP LOG] ' + innerLine);
                    } else {
                      log.debug('[UIAUTO STDOUT] ' + line);
                    }
                  }
                }
              } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
              } finally {
                try {
                  if (!_iteratorNormalCompletion && _iterator['return']) {
                    _iterator['return']();
                  }
                } finally {
                  if (_didIteratorError) {
                    throw _iteratorError;
                  }
                }
              }

              var stderrLines = (stderr || "").split("\n");
              var _iteratorNormalCompletion2 = true;
              var _didIteratorError2 = false;
              var _iteratorError2 = undefined;

              try {
                for (var _iterator2 = _getIterator(stderrLines), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                  var line = _step2.value;

                  if (line.trim()) {
                    log.debug('[UIAUTO STDERR] ' + line);
                  }
                }
              } catch (err) {
                _didIteratorError2 = true;
                _iteratorError2 = err;
              } finally {
                try {
                  if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                    _iterator2['return']();
                  }
                } finally {
                  if (_didIteratorError2) {
                    throw _iteratorError2;
                  }
                }
              }
            });

            // only return when the socket client has connected
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              try {
                _this.socketClient = _net2['default'].connect(_this.systemPort);
                // Windows: the socket errors out when ADB restarts. Let's catch it to avoid crashing.
                _this.socketClient.on('error', function (err) {
                  if (!_this.ignoreUnexpectedShutdown) {
                    throw new Error('Android bootstrap socket crashed: ' + err);
                  }
                });
                _this.socketClient.once('connect', function () {
                  log.info("Android bootstrap socket is now connected");
                  resolve();
                });
              } catch (err) {
                reject(err);
              }
            }));

          case 14:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 17:
            context$2$0.prev = 17;
            context$2$0.t0 = context$2$0['catch'](0);

            log.errorAndThrow('Error occured while starting AndroidBootstrap. Original error: ' + context$2$0.t0);

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 17]]);
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(type) {
      var extra = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.socketClient) {
              context$2$0.next = 2;
              break;
            }

            throw new Error('Socket connection closed unexpectedly');

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              var cmd = _Object$assign({ cmd: type }, extra);
              var cmdJson = JSON.stringify(cmd) + ' \n';
              log.debug('Sending command to android: ' + _lodash2['default'].truncate(cmdJson, { length: 1000 }).trim());
              _this2.socketClient.write(cmdJson);
              _this2.socketClient.setEncoding('utf8');
              var streamData = '';
              var sendCommandTimeoutHandler = null;
              _this2.socketClient.on('data', function (data) {
                if (sendCommandTimeoutHandler) {
                  clearTimeout(sendCommandTimeoutHandler);
                }
                log.debug("Received command result from bootstrap");
                try {
                  streamData = JSON.parse(streamData + data);
                  // we successfully parsed JSON so we've got all the data,
                  // remove the socket listener and evaluate
                  _this2.socketClient.removeAllListeners('data');
                  if (streamData.status === 0) {
                    return resolve(streamData.value);
                  }
                  reject((0, _appiumBaseDriver.errorFromCode)(streamData.status, streamData.value));
                } catch (err) {
                  if (!_lodash2['default'].isString(streamData)) {
                    log.error('Got an unexpected error inside socket listener');
                    log.error(err.stack);
                    return reject((0, _appiumBaseDriver.errorFromCode)(13, err.message));
                  }
                  log.debug('Stream still not complete, waiting up to ' + SEND_COMMAND_TIMEOUT + 'ms for the data to arrive');
                  streamData += data;
                  sendCommandTimeoutHandler = setTimeout(function () {
                    var errMsg = 'Server socket stopped responding. The recent response was \'' + streamData + '\'';
                    log.error(errMsg);
                    _this2.socketClient.removeAllListeners('data');
                    reject((0, _appiumBaseDriver.errorFromCode)(13, errMsg));
                  }, SEND_COMMAND_TIMEOUT);
                }
              });
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'sendAction',
    value: function sendAction(action) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var extra;
      return _regeneratorRuntime.async(function sendAction$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            extra = { action: action, params: params };
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.sendCommand(COMMAND_TYPES.ACTION, extra));

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.uiAutomator) {
              context$2$0.next = 3;
              break;
            }

            log.warn("Cannot shut down Android bootstrap; it has already shut down");
            return context$2$0.abrupt('return');

          case 3:

            // remove listners so we don't trigger unexpected shutdown
            this.uiAutomator.removeAllListeners(_appiumUiautomator2['default'].EVENT_CHANGED);

            if (!this.socketClient) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.sendCommand(COMMAND_TYPES.SHUTDOWN));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.uiAutomator.shutdown());

          case 9:
            this.uiAutomator = null;

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // this helper function makes unit testing easier.
  }, {
    key: 'init',
    value: function init() {
      return _regeneratorRuntime.async(function init$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.uiAutomator = new _appiumUiautomator2['default'](this.adb);

            // Handle unexpected UiAutomator shutdown
            this.uiAutomator.on(_appiumUiautomator2['default'].EVENT_CHANGED, function callee$2$0(msg) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (msg.state === _appiumUiautomator2['default'].STATE_STOPPED) {
                      this.uiAutomator = null;
                      this.onUnexpectedShutdown.cancel(new Error("UiAUtomator shut down unexpectedly"));
                    }

                  case 1:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            });

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'onUnexpectedShutdown',
    get: function get() {
      if (!this._onUnexpectedShutdownPromise) {
        var reject = undefined;
        this._onUnexpectedShutdownPromise = new _bluebird2['default'](function (_resolve, _reject) {
          reject = _reject;
        });
        this._onUnexpectedShutdownPromise.cancel = reject;
      }
      return this._onUnexpectedShutdownPromise;
    }
  }, {
    key: 'ignoreUnexpectedShutdown',
    set: function set(ignore) {
      log.debug((ignore ? 'Ignoring' : 'Watching for') + ' bootstrap disconnect');
      this._ignoreUnexpectedShutdown = ignore;
    },
    get: function get() {
      return this._ignoreUnexpectedShutdown;
    }
  }]);

  return AndroidBootstrap;
})();

exports.AndroidBootstrap = AndroidBootstrap;
exports.COMMAND_TYPES = COMMAND_TYPES;
exports['default'] = AndroidBootstrap;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Ozs7OzthQUNGLENBQUMsQ0FBQzs7Ozs7OztLQUNKOzs7U0FyS3dCLGVBQUc7QUFDMUIsVUFBSSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRTtBQUN0QyxZQUFJLE1BQU0sWUFBQSxDQUFDO0FBQ1gsWUFBSSxDQUFDLDRCQUE0QixHQUFHLDBCQUFNLFVBQVUsUUFBUSxFQUFFLE9BQU8sRUFBRTtBQUNyRSxnQkFBTSxHQUFHLE9BQU8sQ0FBQztTQUNsQixDQUFDLENBQUM7QUFDSCxZQUFJLENBQUMsNEJBQTRCLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztPQUNuRDtBQUNELGFBQU8sSUFBSSxDQUFDLDRCQUE0QixDQUFDO0tBQzFDOzs7U0E4SjRCLGFBQUMsTUFBTSxFQUFFO0FBQ3BDLFNBQUcsQ0FBQyxLQUFLLEVBQUksTUFBTSxHQUFHLFVBQVUsR0FBRyxjQUFjLENBQUEsMkJBQXdCLENBQUM7QUFDMUUsVUFBSSxDQUFDLHlCQUF5QixHQUFHLE1BQU0sQ0FBQztLQUN6QztTQUU0QixlQUFHO0FBQzlCLGFBQU8sSUFBSSxDQUFDLHlCQUF5QixDQUFDO0tBQ3ZDOzs7U0F0TEcsZ0JBQWdCOzs7UUF5TGIsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQUFFLGFBQWEsR0FBYixhQUFhO3FCQUN6QixnQkFBZ0IiLCJmaWxlIjoibGliL2Jvb3RzdHJhcC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBVaUF1dG9tYXRvciBmcm9tICdhcHBpdW0tdWlhdXRvbWF0b3InO1xuaW1wb3J0IG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JGcm9tQ29kZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignQW5kcm9pZEJvb3RzdHJhcCcpO1xuY29uc3QgQ09NTUFORF9UWVBFUyA9IHtcbiAgQUNUSU9OOiAnYWN0aW9uJyxcbiAgU0hVVERPV046ICdzaHV0ZG93bidcbn07XG5jb25zdCBTRU5EX0NPTU1BTkRfVElNRU9VVCA9IDEgKiA2MCAqIDEwMDA7XG5cbmNsYXNzIEFuZHJvaWRCb290c3RyYXAge1xuICBjb25zdHJ1Y3RvciAoYWRiLCBzeXN0ZW1Qb3J0ID0gNDcyNCwgd2ViU29ja2V0ID0gdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5hZGIgPSBhZGI7XG4gICAgdGhpcy5zeXN0ZW1Qb3J0ID0gc3lzdGVtUG9ydDtcbiAgICB0aGlzLndlYlNvY2tldCA9IHdlYlNvY2tldDtcbiAgICB0aGlzLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biA9IGZhbHNlO1xuICB9XG5cbiAgZ2V0IG9uVW5leHBlY3RlZFNodXRkb3duICgpIHtcbiAgICBpZiAoIXRoaXMuX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZSkge1xuICAgICAgbGV0IHJlamVjdDtcbiAgICAgIHRoaXMuX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZSA9IG5ldyBCKGZ1bmN0aW9uIChfcmVzb2x2ZSwgX3JlamVjdCkge1xuICAgICAgICByZWplY3QgPSBfcmVqZWN0O1xuICAgICAgfSk7XG4gICAgICB0aGlzLl9vblVuZXhwZWN0ZWRTaHV0ZG93blByb21pc2UuY2FuY2VsID0gcmVqZWN0O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKGFwcFBhY2thZ2UsIGRpc2FibGVBbmRyb2lkV2F0Y2hlcnMgPSBmYWxzZSwgYWNjZXB0U3NsQ2VydHMgPSBmYWxzZSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyk7XG4gICAgICBjb25zdCBzdGFydERldGVjdG9yID0gKHMpID0+IHsgcmV0dXJuIC9BcHBpdW0gU29ja2V0IFNlcnZlciBSZWFkeS8udGVzdChzKTsgfTtcbiAgICAgIGNvbnN0IGJvb3RzdHJhcEphciA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAnYm9vdHN0cmFwJywgJ2JpbicsICdBcHBpdW1Cb290c3RyYXAuamFyJyk7XG5cbiAgICAgIGF3YWl0IHRoaXMuaW5pdCgpO1xuICAgICAgYXdhaXQgdGhpcy5hZGIuZm9yd2FyZFBvcnQodGhpcy5zeXN0ZW1Qb3J0LCA0NzI0KTtcbiAgICAgIHRoaXMucHJvY2VzcyA9IGF3YWl0IHRoaXMudWlBdXRvbWF0b3Iuc3RhcnQoXG4gICAgICAgICAgICAgICAgICAgICAgIGJvb3RzdHJhcEphciwgJ2lvLmFwcGl1bS5hbmRyb2lkLmJvb3RzdHJhcC5Cb290c3RyYXAnLFxuICAgICAgICAgICAgICAgICAgICAgICBzdGFydERldGVjdG9yLCAnLWUnLCAncGtnJywgYXBwUGFja2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgJy1lJywgJ2Rpc2FibGVBbmRyb2lkV2F0Y2hlcnMnLCBkaXNhYmxlQW5kcm9pZFdhdGNoZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAnLWUnLCAnYWNjZXB0U3NsQ2VydHMnLCBhY2NlcHRTc2xDZXJ0cyk7XG5cbiAgICAgIC8vIHByb2Nlc3MgdGhlIG91dHB1dFxuICAgICAgdGhpcy5wcm9jZXNzLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgY29uc3QgYWxlcnRSZSA9IC9FbWl0dGluZyBzeXN0ZW0gYWxlcnQgbWVzc2FnZS87XG4gICAgICAgIGlmIChhbGVydFJlLnRlc3Qoc3Rkb3V0KSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhcIkVtaXR0aW5nIGFsZXJ0IG1lc3NhZ2UuLi5cIik7XG4gICAgICAgICAgaWYgKHRoaXMud2ViU29ja2V0KSB7XG4gICAgICAgICAgICB0aGlzLndlYlNvY2tldC5zb2NrZXRzLmVtaXQoJ2FsZXJ0Jywge21lc3NhZ2U6IHN0ZG91dH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoZSBib290c3RyYXAgbG9nZ2VyIHdyYXBzIGl0cyBvd24gbG9nIGxpbmVzIHdpdGhcbiAgICAgICAgLy8gW0FQUElVTS1VSUFVVE9dIC4uLiBbQVBQSVVNLVVJQVVUT11cbiAgICAgICAgLy8gYW5kIGxlYXZlcyBhY3R1YWwgVWlBdXRvbWF0b3IgbG9ncyBhcyB0aGV5IGFyZVxuICAgICAgICBsZXQgc3Rkb3V0TGluZXMgPSAoc3Rkb3V0IHx8IFwiXCIpLnNwbGl0KFwiXFxuXCIpO1xuICAgICAgICBjb25zdCB1aWF1dG9Mb2cgPSAvXFxbQVBQSVVNLVVJQVVUT1xcXSguKylcXFtcXC9BUFBJVU0tVUlBVVRPXFxdLztcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBzdGRvdXRMaW5lcykge1xuICAgICAgICAgIGlmIChsaW5lLnRyaW0oKSkge1xuICAgICAgICAgICAgaWYgKHVpYXV0b0xvZy50ZXN0KGxpbmUpKSB7XG4gICAgICAgICAgICAgIGxldCBpbm5lckxpbmUgPSB1aWF1dG9Mb2cuZXhlYyhsaW5lKVsxXS50cmltKCk7XG4gICAgICAgICAgICAgIGxldCBsb2dNZXRob2QgPSBsb2cuaW5mby5iaW5kKGxvZyk7XG4gICAgICAgICAgICAgIC8vIGlmIHRoZSBib290c3RyYXAgbG9nIGNvbnNpZGVycyBzb21ldGhpbmcgZGVidWcsIGxvZyB0aGF0IGFzXG4gICAgICAgICAgICAgIC8vIGRlYnVnIGFuZCBub3QgaW5mb1xuICAgICAgICAgICAgICBpZiAoL1xcW2RlYnVnXFxdLy50ZXN0KGlubmVyTGluZSkpIHtcbiAgICAgICAgICAgICAgICBsb2dNZXRob2QgPSBsb2cuZGVidWcuYmluZChsb2cpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGxvZ01ldGhvZChgW0JPT1RTVFJBUCBMT0ddICR7aW5uZXJMaW5lfWApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbG9nLmRlYnVnKGBbVUlBVVRPIFNURE9VVF0gJHtsaW5lfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzdGRlcnJMaW5lcyA9IChzdGRlcnIgfHwgXCJcIikuc3BsaXQoXCJcXG5cIik7XG4gICAgICAgIGZvciAobGV0IGxpbmUgb2Ygc3RkZXJyTGluZXMpIHtcbiAgICAgICAgICBpZiAobGluZS50cmltKCkpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgW1VJQVVUTyBTVERFUlJdICR7bGluZX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICAvLyBvbmx5IHJldHVybiB3aGVuIHRoZSBzb2NrZXQgY2xpZW50IGhhcyBjb25uZWN0ZWRcbiAgICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQgPSBuZXQuY29ubmVjdCh0aGlzLnN5c3RlbVBvcnQpO1xuICAgICAgICAgIC8vIFdpbmRvd3M6IHRoZSBzb2NrZXQgZXJyb3JzIG91dCB3aGVuIEFEQiByZXN0YXJ0cy4gTGV0J3MgY2F0Y2ggaXQgdG8gYXZvaWQgY3Jhc2hpbmcuXG4gICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93bikge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEFuZHJvaWQgYm9vdHN0cmFwIHNvY2tldCBjcmFzaGVkOiAke2Vycn1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5vbmNlKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICAgICAgbG9nLmluZm8oXCJBbmRyb2lkIGJvb3RzdHJhcCBzb2NrZXQgaXMgbm93IGNvbm5lY3RlZFwiKTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYEVycm9yIG9jY3VyZWQgd2hpbGUgc3RhcnRpbmcgQW5kcm9pZEJvb3RzdHJhcC4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kICh0eXBlLCBleHRyYSA9IHt9KSB7XG4gICAgaWYgKCF0aGlzLnNvY2tldENsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgY29ubmVjdGlvbiBjbG9zZWQgdW5leHBlY3RlZGx5Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBjbWQgPSBPYmplY3QuYXNzaWduKHtjbWQ6IHR5cGV9LCBleHRyYSk7XG4gICAgICBsZXQgY21kSnNvbiA9IGAke0pTT04uc3RyaW5naWZ5KGNtZCl9IFxcbmA7XG4gICAgICBsb2cuZGVidWcoYFNlbmRpbmcgY29tbWFuZCB0byBhbmRyb2lkOiAke18udHJ1bmNhdGUoY21kSnNvbiwge2xlbmd0aDogMTAwMH0pLnRyaW0oKX1gKTtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50LndyaXRlKGNtZEpzb24pO1xuICAgICAgdGhpcy5zb2NrZXRDbGllbnQuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICAgIGxldCBzdHJlYW1EYXRhID0gJyc7XG4gICAgICBsZXQgc2VuZENvbW1hbmRUaW1lb3V0SGFuZGxlciA9IG51bGw7XG4gICAgICB0aGlzLnNvY2tldENsaWVudC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgIGlmIChzZW5kQ29tbWFuZFRpbWVvdXRIYW5kbGVyKSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHNlbmRDb21tYW5kVGltZW91dEhhbmRsZXIpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5kZWJ1ZyhcIlJlY2VpdmVkIGNvbW1hbmQgcmVzdWx0IGZyb20gYm9vdHN0cmFwXCIpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHN0cmVhbURhdGEgPSBKU09OLnBhcnNlKHN0cmVhbURhdGEgKyBkYXRhKTtcbiAgICAgICAgICAvLyB3ZSBzdWNjZXNzZnVsbHkgcGFyc2VkIEpTT04gc28gd2UndmUgZ290IGFsbCB0aGUgZGF0YSxcbiAgICAgICAgICAvLyByZW1vdmUgdGhlIHNvY2tldCBsaXN0ZW5lciBhbmQgZXZhbHVhdGVcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2RhdGEnKTtcbiAgICAgICAgICBpZiAoc3RyZWFtRGF0YS5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHN0cmVhbURhdGEudmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZWplY3QoZXJyb3JGcm9tQ29kZShzdHJlYW1EYXRhLnN0YXR1cywgc3RyZWFtRGF0YS52YWx1ZSkpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBpZiAoIV8uaXNTdHJpbmcoc3RyZWFtRGF0YSkpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcignR290IGFuIHVuZXhwZWN0ZWQgZXJyb3IgaW5zaWRlIHNvY2tldCBsaXN0ZW5lcicpO1xuICAgICAgICAgICAgbG9nLmVycm9yKGVyci5zdGFjayk7XG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yRnJvbUNvZGUoMTMsIGVyci5tZXNzYWdlKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZy5kZWJ1ZyhgU3RyZWFtIHN0aWxsIG5vdCBjb21wbGV0ZSwgd2FpdGluZyB1cCB0byAke1NFTkRfQ09NTUFORF9USU1FT1VUfW1zIGZvciB0aGUgZGF0YSB0byBhcnJpdmVgKTtcbiAgICAgICAgICBzdHJlYW1EYXRhICs9IGRhdGE7XG4gICAgICAgICAgc2VuZENvbW1hbmRUaW1lb3V0SGFuZGxlciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXJyTXNnID0gYFNlcnZlciBzb2NrZXQgc3RvcHBlZCByZXNwb25kaW5nLiBUaGUgcmVjZW50IHJlc3BvbnNlIHdhcyAnJHtzdHJlYW1EYXRhfSdgO1xuICAgICAgICAgICAgbG9nLmVycm9yKGVyck1zZyk7XG4gICAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2RhdGEnKTtcbiAgICAgICAgICAgIHJlamVjdChlcnJvckZyb21Db2RlKDEzLCBlcnJNc2cpKTtcbiAgICAgICAgICB9LCBTRU5EX0NPTU1BTkRfVElNRU9VVCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc2VuZEFjdGlvbiAoYWN0aW9uLCBwYXJhbXMgPSB7fSkge1xuICAgIGxldCBleHRyYSA9IHthY3Rpb24sIHBhcmFtc307XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoQ09NTUFORF9UWVBFUy5BQ1RJT04sIGV4dHJhKTtcbiAgfVxuXG4gIGFzeW5jIHNodXRkb3duICgpIHtcbiAgICBpZiAoIXRoaXMudWlBdXRvbWF0b3IpIHtcbiAgICAgIGxvZy53YXJuKFwiQ2Fubm90IHNodXQgZG93biBBbmRyb2lkIGJvb3RzdHJhcDsgaXQgaGFzIGFscmVhZHkgc2h1dCBkb3duXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHJlbW92ZSBsaXN0bmVycyBzbyB3ZSBkb24ndCB0cmlnZ2VyIHVuZXhwZWN0ZWQgc2h1dGRvd25cbiAgICB0aGlzLnVpQXV0b21hdG9yLnJlbW92ZUFsbExpc3RlbmVycyhVaUF1dG9tYXRvci5FVkVOVF9DSEFOR0VEKTtcbiAgICBpZiAodGhpcy5zb2NrZXRDbGllbnQpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoQ09NTUFORF9UWVBFUy5TSFVURE9XTik7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMudWlBdXRvbWF0b3Iuc2h1dGRvd24oKTtcbiAgICB0aGlzLnVpQXV0b21hdG9yID0gbnVsbDtcbiAgfVxuXG4gIC8vIHRoaXMgaGVscGVyIGZ1bmN0aW9uIG1ha2VzIHVuaXQgdGVzdGluZyBlYXNpZXIuXG4gIGFzeW5jIGluaXQgKCkge1xuICAgIHRoaXMudWlBdXRvbWF0b3IgPSBuZXcgVWlBdXRvbWF0b3IodGhpcy5hZGIpO1xuXG4gICAgLy8gSGFuZGxlIHVuZXhwZWN0ZWQgVWlBdXRvbWF0b3Igc2h1dGRvd25cbiAgICB0aGlzLnVpQXV0b21hdG9yLm9uKFVpQXV0b21hdG9yLkVWRU5UX0NIQU5HRUQsIGFzeW5jIChtc2cpID0+IHtcbiAgICAgIGlmIChtc2cuc3RhdGUgPT09IFVpQXV0b21hdG9yLlNUQVRFX1NUT1BQRUQpIHtcbiAgICAgICAgdGhpcy51aUF1dG9tYXRvciA9IG51bGw7XG4gICAgICAgIHRoaXMub25VbmV4cGVjdGVkU2h1dGRvd24uY2FuY2VsKG5ldyBFcnJvcihcIlVpQVV0b21hdG9yIHNodXQgZG93biB1bmV4cGVjdGVkbHlcIikpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc2V0IGlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biAoaWdub3JlKSB7XG4gICAgbG9nLmRlYnVnKGAke2lnbm9yZSA/ICdJZ25vcmluZycgOiAnV2F0Y2hpbmcgZm9yJ30gYm9vdHN0cmFwIGRpc2Nvbm5lY3RgKTtcbiAgICB0aGlzLl9pZ25vcmVVbmV4cGVjdGVkU2h1dGRvd24gPSBpZ25vcmU7XG4gIH1cblxuICBnZXQgaWdub3JlVW5leHBlY3RlZFNodXRkb3duICgpIHtcbiAgICByZXR1cm4gdGhpcy5faWdub3JlVW5leHBlY3RlZFNodXRkb3duO1xuICB9XG59XG5cbmV4cG9ydCB7IEFuZHJvaWRCb290c3RyYXAsIENPTU1BTkRfVFlQRVMgfTtcbmV4cG9ydCBkZWZhdWx0IEFuZHJvaWRCb290c3RyYXA7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
